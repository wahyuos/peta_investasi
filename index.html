<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="google" value="notranslate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="whykmldn">
    <meta name="description" content="Peta sebaran investasi di Kabupaten Ciamis">
    <meta name="theme-color" content="#1d4ed8">
    <link rel="shortcut icon" href="favicon.png">
    <title>Peta Investasi Kabupaten Ciamis</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        #filter {
            position: absolute;
            top: 10px;
            left: 60px;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            font-family: sans-serif;
        }

        .label-kecamatan {
            background: rgba(255, 255, 255, 0.75);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            color: #333;
            text-align: center;
            white-space: nowrap;
            pointer-events: none;
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.5s ease, transform 0.3s ease;
        }

        .label-hidden {
            opacity: 0;
        }

        .legend {
            position: relative;
            bottom: 10px;
            background: white;
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            line-height: 18px;
            color: #333;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }

        /* .leaflet-top.leaflet-right .legend {
            margin-top: 20px;
            margin-right: 10px;
        } */

        @media (max-width: 768px) {
            .legend {
                bottom: 60px !important;
                /* beri jarak dari bawah */
                right: 10px !important;
                max-width: 150px;
                /* biar tidak melebar */
                font-size: 11px;
            }
        }
    </style>
</head>

<body>
    <div id="filter">
        <label for="tahun">Tahun: </label>
        <select id="tahun"></select>
    </div>
    <div id="map"></div>

    <script>
        // Inisialisasi peta
        const map = L.map('map').setView([-7.2829717, 108.476444], 11); // Koordinat Ciamis

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        let semuaData = {};
        let tahunAktif;
        let geojsonLayer;
        let markerLayer = L.layerGroup().addTo(map);
        let labelLayer = L.layerGroup().addTo(map);

        function getColor(nilai) {
            return nilai === 0 ? '#888' : // abu gelap untuk nilai 0
                nilai > 50000000000 ? '#4B0082' : // ungu tua
                    nilai > 20000000000 ? '#6A0DAD' :
                        nilai > 10000000000 ? '#9370DB' :
                            nilai > 5000000000 ? '#C8A2C8' :
                                '#E6E6FA'; // lavender muda
        }

        function style(feature) {
            const nilai = semuaData[tahunAktif]?.[feature.properties.nama]?.nilai || 0;
            return {
                fillColor: getColor(nilai),
                weight: 1,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.6
            };
        }

        // Highlight interaktif
        function highlightFeature(e) {
            const layer = e.target;
            layer.setStyle({
                weight: 2,
                color: '#666',
                fillOpacity: 0.8
            });
            layer.bringToFront();
        }

        function resetHighlight(e) {
            geojsonLayer.resetStyle(e.target);
        }

        function zoomToFeature(e) {
            map.fitBounds(e.target.getBounds());
        }

        function renderPeta() {
            if (geojsonLayer) map.removeLayer(geojsonLayer);
            markerLayer.clearLayers();
            labelLayer.clearLayers();

            fetch('data/ciamis.geojson')
                .then(res => res.json())
                .then(geoData => {
                    geojsonLayer = L.geoJSON(geoData, {
                        style: style,
                        onEachFeature: (feature, layer) => {
                            const nama = feature.properties.nama;
                            const info = semuaData[tahunAktif]?.[nama];
                            if (!info) {
                                layer.bindPopup(`<b>${nama}</b><br>Data belum ada.`);
                                return;
                            }

                            layer.bindPopup(`
                                <b>${nama}</b><br>
                                ${tahunAktif}<br>
                                Total Investasi: <b>Rp ${info.nilai.toLocaleString()}</b><br>
                                Sektor: ${info.sektor}
                            `);

                            layer.on({
                                mouseover: highlightFeature,
                                mouseout: resetHighlight,
                                click: zoomToFeature
                            });
                        }
                    }).addTo(map);

                    // Pastikan marker muncul setelah layer benar-benar ditambahkan
                    geojsonLayer.eachLayer(layer => {
                        try {
                            const latlng = [layer.feature.properties.lat, layer.feature.properties.lng];

                            const nama = layer.feature.properties.nama;
                            const info = semuaData[tahunAktif]?.[nama];

                            // Marker dengan popup
                            const markerText = info
                                ? `<b>${nama}</b><br>
                                ${tahunAktif}<br>
                                Total Investasi: <b>Rp ${info.nilai.toLocaleString()}</b><br>
                                Sektor: ${info.sektor}`
                                : `<b>${nama}</b><br>Data belum ada`;
                            L.marker(latlng).bindPopup(markerText).addTo(markerLayer);

                            // Label permanen di tengah polygon
                            const label = L.marker(latlng, {
                                icon: L.divIcon({
                                    className: 'label-kecamatan',
                                    html: nama,
                                    iconSize: [100, 20]
                                }),
                                interactive: false
                            });
                            label.addTo(labelLayer);
                        } catch (e) {
                            console.warn("Gagal membuat marker/label untuk:", layer.feature.properties.nama_kecamatan);
                        }
                    });
                });
        }

        // Load semua data investasi
        fetch('data/investasi.json')
            .then(res => res.json())
            .then(data => {
                semuaData = data;
                const tahunList = Object.keys(data).sort();
                const select = document.getElementById('tahun');
                tahunList.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.textContent = t;
                    select.appendChild(opt);
                });
                tahunAktif = tahunList[tahunList.length - 1]; // tahun terakhir
                select.value = tahunAktif;
                renderPeta();

                select.addEventListener('change', e => {
                    tahunAktif = e.target.value;
                    renderPeta();
                });
            });



        // Legenda
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function () {
            const div = L.DomUtil.create('div', 'legend');
            const grades = [0, 5000000000, 10000000000, 20000000000, 50000000000];
            div.innerHTML += '<b>Nilai Investasi</b><br>';
            for (let i = 0; i < grades.length; i++) {
                const from = grades[i];
                const to = grades[i + 1];
                div.innerHTML +=
                    '<i style="background:' + getColor(from + 1) + '"></i> ' +
                    'Rp ' + from.toLocaleString() +
                    (to ? '&ndash; Rp ' + to.toLocaleString() + '<br>' : '+');
            }
            return div;
        };
        legend.addTo(map);

        map.on('zoomend zoom', () => {
            const currentZoom = map.getZoom();
            if (currentZoom < 11) {
                if (map.hasLayer(labelLayer)) {
                    map.removeLayer(labelLayer);
                }
            } else {
                if (!map.hasLayer(labelLayer)) {
                    map.addLayer(labelLayer);
                }
            }
        });



    </script>
</body>

</html>